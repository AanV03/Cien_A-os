<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Macondo API</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
    <link href="./css/style.css" rel="stylesheet">
</head>

<body>
    <!-- Topbar Start -->
    <div class="container-fluid bg-dark">
        <div class="row py-2 px-lg-5">
            <div class="col-lg-6 text-center text-lg-left mb-2 mb-lg-0">
                <div class="d-inline-flex align-items-center text-white"></div>
            </div>
        </div>
    </div>
    <!-- Topbar End -->


    <!-- Navbar Start -->
    <div class="container-fluid p-0">
        <nav class="navbar navbar-expand-lg bg-light navbar-light py-3 py-lg-0 px-lg-5">
            <a href="index.html" class="navbar-brand ml-lg-3">
                <h1 class="m-0 display-5 text-uppercase text-primary"><i class="fa fa-truck mr-2"></i>MacondoAPI</h1>
            </a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse">
                <span class="bi bi-book"></span>
            </button>

            <div class="collapse navbar-collapse justify-content-between px-lg-3">
                <div class="navbar-nav m-auto py-0">
                    <a href="price.html" class="nav-item nav-link">Hola que hace</a>
                </div>
            </div>
        </nav>
    </div>
    <!-- Navbar End -->

    <!-- Header Start -->
    <div class="jumbotron jumbotron-fluid mb-5">
        <div class="container text-center py-5">
            <h1 class="text-primary mb-4">Capítulos 10, 11 y 12</h1>
            <h1 class="text-white display-3 mb-5">Cien años de soledad</h1>
            <div class="mx-auto" style="width: 100%; max-width: 600px;">
                <div class="input-group">
                    <input id="queryInput" type="text" class="form-control border-light" style="padding: 30px;"
                        placeholder="Busca lo que quieras">
                    <div class="input-group-append">
                        <button id="searchBtn" class="btn btn-primary px-3">Buscar</button>
                    </div>
                </div>
            </div>
            <!-- Contenedor de resultados -->
            <div id="searchResults" class="mt-4 text-left text-white" style="max-width:600px; margin: 0 auto;"></div>
        </div>
    </div>
    <!-- Header End -->

    <!-- Footer Start -->
    <div class="container-fluid bg-dark text-white mt-5 py-5 px-sm-3 px-md-5">
        <div class="row pt-5">
            <div class="col-lg-7 col-md-6">
                <div class="row">
                    <div class="col-md-6 mb-5"></div>
                </div>
                <div class="col-md-6 mb-5"></div>
            </div>
        </div>
    </div>
    <div class="container-fluid bg-dark text-white border-top py-4 px-sm-3 px-md-5"
        style="border-color: #3E3E4E !important;">
        <div class="row"></div>
    </div>
    <!-- Footer End -->

    <!-- Back to Top -->
    <a href="#" class="btn btn-lg btn-primary back-to-top"><i class="fa fa-angle-double-up"></i></a>

    <!-- Contact Javascript File
    <script src="mail/jqBootstrapValidation.min.js"></script>
    <script src="mail/contact.js"></script>

    <!-- Template Javascript -->
    <!-- <script src="js/main.js"></script> -->

    <!-- Búsqueda MacondoAPI -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const input = document.getElementById('queryInput');
            const btn = document.getElementById('searchBtn');
            const out = document.getElementById('searchResults');

            // Detecta pregunta, capítulo o búsqueda simple
            function esPregunta(q) {
                const qNorm = q.toLowerCase();
                return (
                    /[¿?]/.test(q) ||
                    /\b(qu[eé]|cu[aá]ndo|d[oó]nde|por qu[eé]|c[oó]mo|qui[eé]n|para qu[eé]|cu[aá]les?)\b/i.test(qNorm) ||
                    /cap[ií]tulo\s*\d+/i.test(qNorm)
                );
            }

            async function buscar() {
                const q = input.value.trim();
                if (!q) {
                    out.innerHTML = '<p class="text-warning">Escribe algo para buscar…</p>';
                    return;
                }

                out.innerHTML = '<p>Cargando resultados…</p>';

                // Ramifica a /api/preguntas si es pregunta o capítulo
                const endpoint = esPregunta(q)
                    ? `/api/preguntas?q=${encodeURIComponent(q)}`
                    : `/api/buscar?q=${encodeURIComponent(q)}`;

                try {
                    const res = await fetch(endpoint);
                    if (!res.ok) {
                        const err = await res.json();
                        throw new Error(err.error);
                    }
                    const data = await res.json();

                    if (!esPregunta(q)) {
                        // Búsqueda simple: recorre cada colección
                        const keys = Object.keys(data);
                        const total = keys.reduce((sum, k) => sum + data[k].length, 0);
                        if (!total) {
                            out.innerHTML = `<p class="text-info">No se encontraron coincidencias para “${q}”.</p>`;
                            return;
                        }
                        let html = `<h4 class="text-primary">Resultados para “${q}”:</h4>`;
                        keys.forEach(key => {
                            if (data[key].length) {
                                html += `<h5 class="mt-3 text-secondary">${key.charAt(0).toUpperCase() + key.slice(1)}:</h5>`;
                                data[key].forEach(item => {
                                    const title = item.nombre || item.titulo || '—';
                                    const desc = item.descripcion || '';
                                    html += `
                <div class="card mb-2">
                  <div class="card-body">
                    <h5 class="card-title">${title}</h5>
                    <p class="card-text">${desc}</p>
                  </div>
                </div>`;
                                });
                            }
                        });
                        out.innerHTML = html;
                    } else {
                        // Pregunta o capítulo: data = { capitulo, resultados }
                        const { capitulo, resultados } = data;
                        if (!resultados.length) {
                            out.innerHTML = capitulo === 'todos'
                                ? `<p class="text-info">No se encontraron eventos para “${q}”.</p>`
                                : `<p class="text-info">No se encontraron eventos en el capítulo ${capitulo}.</p>`;
                            return;
                        }
                        const header = capitulo === 'todos'
                            ? `<h4 class="text-primary">Resultados para “${q}”:</h4>`
                            : `<h4 class="text-primary">Eventos en capítulo ${capitulo}:</h4>`;
                        const items = resultados.map(ev => `
          <div class="card mb-2">
            <div class="card-body">
              <h5 class="card-title">${ev.nombre}</h5>
              <p class="card-text">${ev.descripcion}</p>
            </div>
          </div>
        `).join('');
                        out.innerHTML = header + items;
                    }
                } catch (e) {
                    console.error(e);
                    out.innerHTML = `<p class="text-danger">Error: ${e.message}</p>`;
                }
            }

            btn.addEventListener('click', buscar);
            input.addEventListener('keydown', e => { if (e.key === 'Enter') buscar(); });
        });
    </script>

</body>

</html>